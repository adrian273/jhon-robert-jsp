//------------------------------------------------------------------------------
/**
 * iniciacion de variables;;
 * @author Adrian
 * @type jQuery
 */
const BASE = $("#base").val();
const ANIMATED_GROUP_OUT = [
    "zoomOutRight", "zoomOutLeft",
    "fadeOutRight", "fadeOutLeft"
];

const ANIMATED_GROUP_IN = [
    "fadeInLeft", "fadeInDown", "fadeInUp", "fadeInRight"
];
//------------------------------------------------------------------------------
$(document).ready(function () {
    $(".navbar-toggler").on("click", function () {
        $("body").toggleClass("navbar--opened");
    });

    $('[data-toggle="tooltip"]').tooltip();

    //--------------------------------------------------------------------------
    // inicio de funciones 
    //--------------------------------------------------------------------------
    isVisible();
    load_count_shopping();
    totalShoppingCart();
    //add_cart();

    //--------------------------------------------------------------------------
    var col_size = $("#col-size").val();
    //alert(col_size);
    if (col_size == 0)
        $("#carousel-example-generic").html("<p>NADA AGREGADO!</p>");
    if (col_size <= 1) {
        $(".col-setting").removeClass("col-md-4").addClass("col-md-12");
    } else if (col_size == 2) {
        $(".col-setting").removeClass("col-md-4").addClass("col-md-6");
    }


});
/**
 * 
 * @param {this} idCheck : input customizado
 * @returns {undefined}
 */
function isVisible(idCheck) {
    let v = $("#visible");
    let msg = "";
    let icon = "";

    if (idCheck === undefined)
        idCheck = "#visible-input";

    if ($(idCheck).is(':checked')) {
        v.prop("value", "1");
        msg = "Visible";
        icon = `<i class="far fa-eye text-success"></i>`;
    } else {
        v.prop("value", "0");
        msg = "oculto";
        icon = `<i class="far fa-eye-slash text-warning"></i>`;
    }
    $(".visible-input-msg").html(`${msg} ${icon}`);
}

/**
 * para ocultar y mostrar datos
 */
$("#t-show").on('click', function (event) {
    event.preventDefault();
    $(".t-hidden").removeClass("d-none");
    $(this).addClass("d-none");
    $("#t-hide").removeClass("d-none");
});

$("#t-hide").on('click', function (event) {
    event.preventDefault();
    $(".t-hidden").addClass("d-none");
    $(this).addClass("d-none");
    $("#t-show").removeClass("d-none");
});

/**
 * -----------------------------------------------------------------------------
 *  @Script Shooping Cart
 * ----------------------------------------------------------------------------- 
 */

/**
 * Agregar nuevos al carrito de compras 
 * @param {type} that
 * @param {type} product_id
 * @param {type} order_id
 * @param {type} price
 * @param {type} stock
 * @returns {undefined}
 */
function add_cart(that, product_id, order_id, price, stock) {
    if (stock > 0) {
        $.ajax({
            url: BASE + "/order_items",
            data: {
                "type": "verific_product",
                "price": price,
                "products_id": product_id,
                "orders_id": order_id
            },
            type: "GET",
            datatype: "html"
        }).done(function (res) {
            if (res == "true") {
                $(that).html("Agregado <i class='fas fa-check'> </i>")
                        .removeClass("btn-dark")
                        .addClass("btn-success");
                load_count_shopping();
            } else if (res == "false") {
                $(that).html("En el carrito! <i class='far fa-1x fa-laugh-squint'></i>")
                        .prop("disabled", true)
                        .removeClass("btn-dark btn-success")
                        .addClass("btn-outlet-info");
                $("#nav-shopping-cart").addClass("animated tada");
            } else {
                $(that).html("Ninguna Accion Realizada <i class='fas fa-bug'></i>")
                        .removeClass("btn-dark btn-success btn-outlet-info")
                        .addClass("btn-danger");
            }
        });
    } else {
        $(that).html("Sin Stock <i class='far fa-1x fa-sad-cry'></i>")
                .prop("disabled", true)
                .removeClass("btn-dark btn-success btn-outlet-info")
                .addClass("btn-warning");
    }
}

/**
 * 
 * @param {this} that
 * @param {number} id
 * @returns {undefined}
 */
function updateQuantity(that, id) {
    var quantity = that.value;
    var stock = $("#stock" + id).val();
    //alert(quantity)
    if (quantity > 0) {
        //alert(stock);
        var name = $("#name" + id).val();
        //alert(Number(quantity) + Number(stock))
        if (Number(quantity) <= Number(stock)) {
            var price_pro = $("#price_pro" + id).val();
            //alert(Number(price_pro))
            $.ajax({
                url: BASE + "/order_items",
                data: {
                    "type": "update_quantity",
                    "quantity": quantity,
                    "price_pro": Number(price_pro),
                    "id": id
                },
                type: "get",
                dataType: "html"
            }).done(function (res) {
                //alert(res)
                $("#sub_total_pro" + id + "label").html(res);

                var config_alert = {
                    animated: "fadeInUp",
                    type: "success",
                    msg: `La cantidad del producto <b>"${name}"</b> se a modificado`,
                    icon: ` <i class="fas fa-check"></i>`,
                    class_: "text-center"
                };
                load_count_shopping();
                totalShoppingCart();
                $("#msg-shooping-cart").html(__template_alert(config_alert));
            }).fail(function (jqXhr, txtStatus, error) {

            });
        } else {
            $(that).prop("value", stock);
            //let name = $("#name" + id).val();
            var config_alert = {
                animated: "fadeInUp",
                type: "warning",
                msg: `El producto <b>"${name}"</b>tiene ${stock} cantidades disponibles`,
                icon: `<i class="far fa-dizzy"></i>`,
                class_: "text-center"
            };
            $("#msg-shooping-cart").html(__template_alert(config_alert));
        }
    }
    //alert(formatPrice(price))
    //alert(that.value + " -> " + id + "-->" + price)
}

/**
 * 
 * @param {number} i
 * @returns {undefined}
 */
function deleteOrder(i) {
    let question = confirm("¿ Esta seguro de remover este producto ?");
    if (question) {
        $.ajax({
            url: BASE + "/order_items",
            data: {
                "type": "delete_order",
                "id": i
            },
            type: "post",
            dataType: "html"
        }).done(function (res) {
            if (res === "true") {
                let name = $("#name" + i).val();
                var config_alert = {
                    animated: "animated fadeInUp",
                    type: "warning",
                    msg: `El producto <b>${name}</b> ha sido removido!`,
                    icon: `<i class="far fa-smile-wink"></i>`,
                    class_: "text-center"
                };
                $("#msg-shooping-cart").html(__template_alert(config_alert));

                var random = Math.floor(Math.random() * ANIMATED_GROUP_OUT.length);
                //alert(ANIMATED_GROUP[random]);
                $("#row_order" + i).addClass("animated " + ANIMATED_GROUP_OUT[random]);
                setTimeout(function () {
                    $("#row_order" + i).remove();
                }, 1500);
                //$(".count-shopping-cart").addClass("animated tada");
                load_count_shopping();
                totalShoppingCart();
            } else {
                load_count_shopping();
                totalShoppingCart();
            }
        }).fail(function (jq, ts, e) {
            alert(jq + " --> " + ts);
        });
    }
}

/**
 * 
 * @returns {undefined}
 */
function totalShoppingCart() {
    const ORDERS_ID = $("#orders_id").val();
    $.ajax({
        url: BASE + "/order_items",
        data: {
            type: "total_shopping_cart",
            id: ORDERS_ID
        },
        type: "get",
        dataType: "html"
    }).done(function (res) {
        if (res === "0") {
            //alert(res)
            $("#checkout-shopping-cart").prop({"disabled": true, "title": "Agrega productos al carrito :)"});
            $(".count-shopping-cart").html("0");
            var config_alert = {
                animated: "animated fadeInUp",
                type: "info",
                msg: `A&ntilde;ade productos al carrito, <a href="${BASE}/index.jsp">Ir a tienda</a>`,
                icon: `<i class="far fa-smile"></i>`,
                class_: "text-center"
            };
            $(".msg-empty-cart").html(__template_alert(config_alert));
        }
        $(".monto_total").html("$" + formatPrice(Number(res)));
        $("#shipping").prop("value", res);
    }).fail(function (jqXhr, txtStatus, error) {

    });
}


$("#checkout-shopping-cart").click(function (event) {
    var random = Math.floor(Math.random() * ANIMATED_GROUP_IN.length);
    var options = "<option></option>";
    $.getJSON(BASE + "/assets/js/regiones.json", function (res) {
        $.each(res, function (k, v) {
            for (var i = 0; i < v.length; i++) {
                console.log(v[i].NombreRegion);
                options += `<option>${v[i].NombreRegion}</option>`;
            }
        });
        $("#region").html(options);
    });

    $("#myModal").addClass("animated " + ANIMATED_GROUP_IN[random]);
    $("#myModal").modal();
});

/**
 * para seleccionar las comunas;;
 * @param {type} that_value
 * @returns {undefined}
 */
function changeTerritory(that_value) {
    var op_comunas = "<option></option>";
    $.getJSON(BASE + "/assets/js/regiones.json", function (res) {
        $.each(res, function (k, v) {
            for (var i = 0; i < v.length; i++) {
                if (that_value !== null) {
                    if (v[i].NombreRegion === that_value) {
                        for (var j = 0; j < v[i].comunas.length; j++) {
                            op_comunas += `<option>${v[i].comunas[j]}</option>`;
                        }
                    }
                }
            }
        });
        $("#comuna").html(op_comunas);
    });
}

$("#confirm-order").on("click", function (event) {
    event.preventDefault();
    var msg_errors = false;
    var msg = "";

    if (!$("input[name=payments_type]").is(':checked')) {
        msg_errors = true;
        msg = "[*] Selecciona metodo de pago <br>";
    }
    if ($("#region").val() == "") {
        msg_errors = true;
        msg += "[*] Selecciona Region <br>";
    }
    if ($("#comuna").val() == "") {
        msg_errors = true;
        msg += "[*] Selecciona Comuna <br>";
    }

    if ($("#address").val() == "") {
        msg_errors = true;
        msg += "[*] Direccion Requerida <br>";
    }

    if (msg_errors === true) {
        var m = msg.replace(/[*]/g, "<i class='fa fa-remove'></i>");
        //alert(m);
        var config_alert = {
            animated: "animated fadeInUp",
            type: "danger",
            msg: `<b>Campos requeridos</b> <br> ${m}`,
            icon: ``,
            class_: "text-left"
        };
        $(".msg-checkout-cart").html(__template_alert(config_alert));
        return false;
    }

    $.ajax({
        url: BASE + "/order",
        data: $("#checkout-cart").serialize(),
        type: "POST",
        dataType: "html"
    }).done(function (res) {
        //alert(res);
        var response = res.split(",");
        if (response[0] === "success") {
            alert('Se ha realizado la compra con exito!');
            window.location.href = BASE + "/order_items?type=shopping_cart&i=" + response[1];
        } else {
            alert("A ocurrido un error inesperado, intente mas tarde!");
        }
        $(".msg-checkout-cart").html("");
    });

});

// -----------------------------------------------------------------------------
// Orders Script
// -----------------------------------------------------------------------------

/**
 * Ver los detalles de las ordenes
 * @param {number} i
 * @returns {url}
 */
function viewOrder(i) {
    //window.location.href = BASE + "/order?type=view_order&i=" + i;
    $.ajax({
        url: BASE + "/order",
        type: "POST",
        data: {
            type: "order_info",
            i: i
        },
        dataType: 'json'
    }).done(function (res) {
        var template = "";
        template = `
            <div  class='col-md-12 table-fixed'>
                <div class='row'>
                    <div class='col-6'>
                        <h6> Fecha de orden: <b>${res.created_at}</b> </h6>
                    </div>
                    <div class='col-6'>
                       <h6> Estado 
                            <span class="badge badge-pill badge-${res.color}" id="res-status">${res.status} 
                            </span> 
                        <a onclick="changeStatusOrder('${res.type_profile}', '${res.status}')" style="cursor:pointer;"> Cambiar </a></h6>
                        <div class="change-status"></div>
                    </div>
                </div>
                <hr>
                <div class='row'>  
                    <div class='col-6'>
                        <h6> Direccion: </h6>
                        <p> ${res.address}</p>   
                    </div>
                    <div class='col-6'>
                        <p> 
                            <b> Region:</b> ${res.region} /
                            <span class='padding-right:15px;'> 
                                <b> Comuna:</b> ${res.comuna} 
                            </span> 
                        </p>
                    </div>
                </div>
          
                <hr>
                <div class='row'>
                    <div class='col-6'>
                        <p> <b>Telefono:</b> ${res.phone} </p>
                    </div>
                    <div class='col-6'>
                        <p> <b>Tipo de Pago:</b> ${res.type} </p>
                    </div>
                </div>
                <h6>Lista de Productos </h6>
                <table class='table table-hover table-dark'>
                    <thead> 
                        <tr>
                            <th>Id</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                        </tr>
                </thead>
                <tbody>
        `;
        for (var i in res.products) {
            template += `
                <tr>
                    <td>${res.products[i].id}</td>
                    <td>${res.products[i].name}</td>
                    <td>$${formatPrice(Number(res.products[i].price))}</td>
                    <td>${res.products[i].quantity}</td>
                    <td>$${formatPrice(Number(res.products[i].subtotal))}</td>
                </tr>
        `;
        }

        template += `
                    </tbody>
                    <tfoot>
                        <tr class="bg-info">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>Total</td>    
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>$${formatPrice(Number(res.shipping))}</td>    
                        </tr>
                    </tfoot>
                    <caption>Total productos: ${res.products.length}</caption>
                </table>
            </div>
        `;
        $(".idOrder").html(res.id);
        $("#idOrderInput").prop("value", res.id);
        $("#info-order-list").html(template);
        $(".monto_total").html("$" + formatPrice(Number(res.shipping)));
    });
    $("#myModalOrder").modal();
}

function changeStatusOrder(values, st) {
    var options;
    var template = `<select onchange=statusOrder(this)><option></option>`;
    if (values === "admin") {
        options = [
            {id: 2, status: "en proceso"},
            {id: 3, status: "enviado"},
            {id: 4, status: "completado"},
            {id: 5, status: "cancelado"}
        ];
    } else {
        options = [
            {id: 5, status: "cancelar"}
        ];
    }
    for (var i in options) {
        if (st === options[i].status) {
            template += `<option value="${options[i].id}" selected>
            ${options[i].status}</option>`;
        } else {
            template += `<option value="${options[i].id}">
            ${options[i].status}</option>`;
        }
    }
    template += `</select>`;

    $(".change-status").html(template);
}

/**
 * 
 * @param {this} that
 * @returns {undefined}
 */
function statusOrder(that) {
    let c = confirm("¿Estas seguro de cambiar el estado?");
    var order = $("#idOrderInput").val();
    //alert(order)
    if (c) {
        $.ajax({
            url: BASE + "/order",
            data: {
                status: that.value,
                i: order,
                type: "change_status"
            },
            type: "post",
            dataType: "json"
        }).done(function (response) {
            var config_alert = {
                animated: "animated fadeInUp",
                type: `${response.class_}`,
                msg: `<b>[${response.type}]</b> ${response.msg} <br>`,
                icon: ``,
                class_: "text-left"
            };
            if (response.type === "success")
                $("input[name=status_reload]").prop("value", 1);
            $(".update-alert").html(__template_alert(config_alert));
            var options = [
                {id: 2, status: "en proceso"},
                {id: 3, status: "enviado"},
                {id: 4, status: "completado"},
                {id: 5, status: "cancelado"}
            ];
            const rOp = options.find(op => op.id === Number(that.value));
            $("#res-status").html(rOp.status);
            //$(".change-status").html("");
        }).fail(function (jqXHR, txtStatus, error) {
            alert(txtStatus + "--->" + error);
        });
    }
}

$('#myModalOrder').on('hidden.bs.modal', function (e) {
    /*if ($("input[name=status_reload]").val() === "1") {
     window.location.href = BASE + "/order?type=all_orders";
     }
     $("input[name=status_reload]").prop("value", 0);
     $(".update-alert").html("");*/
    var type_profile = $("#type_profile").val();
    if (type_profile !== "admin") {
        closeModalReload("/order?type=my_order");
    } else {
        closeModalReload("/order?type=all_orders");
    }
});
// -----------------------------------------------------------------------------
// @Users Script
// -----------------------------------------------------------------------------

/**
 * 
 * @param {type} i
 * @returns {undefined}
 */
function viewInfoUser(i) {
    $.ajax({
        url: BASE + "/userc",
        data: {
            i: i,
            view: "view-info"
        },
        type: 'GET',
        dataType: 'json'
    }).done(function (res) {
        $("#id-user").prop("value", res.id);
        $("#name").html(res.name.toUpperCase());
        $("#correo").html(res.email);
        $("#date-created").html(res.created_at);
        $("#type-profile").html(res.type.toUpperCase());
        if (res.type === "admin") {
            $("#type-profile").addClass("text-primary").removeClass("text-warning");
        } else {
            $("#type-profile").addClass("text-warning").removeClass("text-primary");
        }
    }).fail((jqXHR, txtStatus, error) => {
        alert(`${txtStatus} --> ${error}`);
    });
    $("#myModalUser").modal();
}

/**
 * 
 * @param {type} that
 * @returns {undefined}
 */
function changeSelectType(that) {
    console.log(that);
    //$("#user-type").removeClass('d-none');
    var options = ['admin', 'general'];
    var template = `<select name="type" style="width:150px;" id="type" class="form-control" onchange="changeType(this)">`;
    for (var i = 0; i < options.length; i++) {
        if (that.innerHTML.toLowerCase() === options[i]) {
            template += `<option selected> ${options[i]}</option>`;
        } else {
            template += `<option> ${options[i]}</option>`;
        }
    }
    template += `</select> 
                <a href="#!" onclick="closeSelectType('${that}');">Cerrar</a>`;
    $(that).html(template);
}

/**
 * change profile admin
 * @param {type} that
 * @returns {undefined}
 */
function changeType(that) {
    //alert(that.value);
    $.ajax({
        url: BASE + "/userc",
        data: {
            i: $("#id-user").val(),
            view: 'change-type',
            type: that.value
        },
        type: 'get',
        dataType: 'json'
    }).done(function (res) {
        var config_alert = {
            animated: "animated fadeInUp",
            type: `${res.class_}`,
            msg: `<b>[${res.type}]</b> ${res.msg} <br>`,
            icon: ``,
            class_: "text-left"
        };
        if (res.type === "success")
            $("input[name=status_reload]").prop("value", 1);
        $(".update-alert").html(__template_alert(config_alert));
    }).fail(function (x, t, e) {
        alert(t);
    });
}

function closeSelectType(that) {
    //alert($("input[name=status_reload]").val());
    var type = $("#type").val();
    $("#type-profile").html(type.toUpperCase()).css("color", "green");
}

$('#myModalUser').on('hidden.bs.modal', function (e) {
    // evento para cuando se cierre el modal;;
    /*if ($("input[name=status_reload]").val() === "1") {
     //alert("se edito");
     window.location.href = BASE + "/userc?view=grid";
     }
     $("input[name=status_reload]").prop("value", 0);
     $(".update-alert").html("");*/
    closeModalReload("/userc?view=grid");
});

//------------------------------------------------------------------------------
// @products
//------------------------------------------------------------------------------

function changeUploadImage(type) {
    switch (type) {
        case "upload-file":
            $(".image-product").prop({"type": "file", "disabled": false, "name": "image_file"});
            break;
        case "url":
            var temp = $("#img-temp").val();
            $(".image-product").prop({"type": "text",
                "value": temp, "disabled": false, "placeholder": "Pega una url de imagen", "name": "image"});
            break;
        case "default":
        default:
            $(".image-product").prop({"value": "", "type": "text", "disabled": "true",
                "placeholder": "Imagen por defecto del sistema", "name": "image"});
            //$(".image-product").prop("type", "text");
            //alert(type);
            break;
    }
}

//------------------------------------------------------------------------------
// Helpers
//------------------------------------------------------------------------------
/**
 * 
 * @param {type} number
 * @returns {String}
 */
function formatPrice(number) {
    number = String(number).replace(/\D/g, "");
    return number === "" ? number : Number(number).toLocaleString();
}

/**
 * 
 * @param {object} config
 * animated, type, msg, icon, class_
 * @returns {String}
 */
function __template_alert(config) {
    if (config.class_ === null)
        config.class_ = "";
    return `
        <div class="alert alert-${config.type} alert-dismissible animated ${config.animated} show ${config.class_}" role="alert">
            ${config.msg} ${config.icon}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
}

/**
 * 
 * @param {string} url
 * @returns {undefined}
 */
function closeModalReload(url) {
    if ($("input[name=status_reload]").val() === "1") {
        //alert("se edito");
        window.location.href = BASE + url;
    }
    $("input[name=status_reload]").prop("value", 0);
    $(".update-alert").html("");
}